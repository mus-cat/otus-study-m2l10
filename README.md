# Bash.
## Задание выполнялось с использованием VirtualBox 6.1.40, использовался vagrant с box-образом generic/debian10 (debian 10.13)

Написать скрипт для CRON, который раз в час будет формировать письмо и отправлять на заданную почту.
Необходимая информация в письме:  
- Список IP адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта.
- Список запрашиваемых URL (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта.
- Ошибки веб-сервера/приложения c момента последнего запуска.
- Список всех кодов HTTP ответа с указанием их кол-ва с момента последнего запуска скрипта.
- Скрипт должен предотвращать одновременный запуск нескольких копий, до его завершения.

ВМ создаётся vagrant (файл ***Vagrantfile*), настройка осуществляется в соответсвии с файлом **cronTask.yml**. Файл **access.log.orig** это исходный файл представленный в задании, в процессе настройки из него содаются файлы **access.log**, **access.log.1**, **access.log.2.gz** имитирующие стандартное расподопжние файлов логов для apache2. Скрипт **procAccWebStat.sh** устанавливается в **crontab** для `root`. В результате работы скрипта генерируется писмо.
### Про переменные
`forMail` - задает адрес получателя письма
`whereFind` - задет папку, в которой будут искаться лог-файлы вида access.log*
`sendLines` - задаёт max число ip,urls и http_code выбираемых из результата обработки лог-файло и вставляемых в письмо (полные результаы работы скрипта остаются в диретории **/tmp** соответственно в файлах **ips.res**, **urls.res** и **httpCode.res**)

Общая идея работы скрипта:
1. Скрипт для нахождения необработанных строк (т.е. новых) использует последнюю обработанную при предыдущем вызове строку сохраняемую в файле **/var/log/apache2/lastaccline**. Данный файл считывается при старте скрипта. Если файл пустой или отсутствует, считается что время начала поиска = 0 (т.е. перебираются все файлы логов). Используется конкретная строка, а не время взятое из нее, т.к. строк содержащих такое же время может быть много, к тому же на момент разбора файлы не все такие строки могут быть записаны в файл.
2. Последовательно перебираются лог-файлы от более нового к более старому. Процесс идет пока во временные рамки обрабатываемого лог-файлом (время извлекается из первой и последней строки файлы) попадает времея извлеченное из строки в фале **lastaccline**, попутно осуществляется поиск все строки из файла **lastaccline** (сохраняется номер позиции в которой найдена строка). На выходе получаем массив содержащий лог-фалы с новыми строками (весь файл или частично).
3. Массив файлов обрабатывается с конца (файлы со старыми данными) к началу (более свежим данным). Их содержимое записывается в файл **/tmp/procaccfile**, для файла в которм найдена строка пишутся только строки после нее. В результате получается файл содержаший "новые" строки, он может быть и пустым.
4. Если файл создаваемый на предыдущем шаге пуст => нет необработанных ранее данных, об этом и пишем в письме... Если файл не пуст,на него натравливается **awk**, который: 
- каждую строку файла "режет" на нужные поля;
- заполняет ассоциированные массивы, где в качестве ключей используются то или иное поле;
- в завершении сохраняет содержимое массивов в фалы **ips.res**, **urls.res** и **httpCode.res**.
5. Создаем письмо и подчищаем файлы

P.S. Пункт `Ошибки веб-сервера/приложения c момента последнего запуска.` не стал делать, решил, что уже не принципиально дополнительно разбирать еще и файлы **error.log\***
